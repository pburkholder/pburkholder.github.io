
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Clearing the Counter Pt II: Knife Cleanup Tweaks #chef - A Blog</title>
  <meta name="author" content="Peter Burkholder">

  
  <meta name="description" content="Part Two: knife cleanup versions A colleague at $WORK discovered a plugin by Marius Ducea which would remove unused cookbook versions from a chef &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://pburkholder.github.io/blog/2014/07/29/clearing-the-counter-pt-ii-knife-cleanup-tweaks/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="A Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">A Blog</a></h1>
  
    <h2>An occasional data tap into Peter Burkholder&#8217;s brain</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="pburkholder.github.io">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Clearing the Counter Pt II: Knife Cleanup Tweaks #chef</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-07-29T12:50:11-04:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>29</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>12:50 pm</span></time>
        
           | <a href="#disqus_thread"
             data-disqus-identifier="http://pburkholder.github.io">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>Part Two: knife cleanup versions</p>

<p>A colleague at $WORK discovered a plugin by Marius Ducea which would remove unused cookbook versions from a chef server. The plugin provided you the option of dumping all cookbooks locally before deleting them. The problem we saw was that ‘unused’ meant &lsquo;&#8217;not explicitly pinned’ with equality; it disregarded ~> and >=, etc. So we could not use the plugin without trashing many of our cookbooks in use.</p>

<p>I extended the plugin to take a &ndash;runlist parameter, so it would query the chef server for the cookbook versions needed to satisfy that runlist, and do so for each of the environments present on the server. At the time we were not using Chef’s built-in roles, as some of us had mis-read/mis-understood work such as The Berkshelf Way or A Year with Chef. We had one cookbook work-roles, which in turn had recipes such as workroles::mongo or workroles::api. To clean up cookbooks, I’d run:</p>

<p>knife cleanup versions &ndash;runlist &lsquo;&#8217;workroles::default&rsquo;&#8217;</p>

<p>and it would list all the cookbooks eligible for deletion. Then I’d run that again with the -D option to actually do the deletion. A few score cookbooks would poof go away and our depsolver issues would be gone.</p>

<p>I have a PR open with Marius but I’ve not heard back since Christmas.</p>

<p>Meanwhile, you can use it from my GitHub runlist_feature branch.</p>

<p>What about roles?</p>

<p>Turns out that one master roles cookbook is an anti-pattern. That’s a story for another time. Chef roles are great if they’re kept lightweight; they were unfairly maligned by abuses heaped upon them.</p>

<p>My branch of knife-cleanup doesn’t handle roles well, since it expects a runlist of recipes, so I’ll need to address that.</p>

<p>Unless cookbook clean up has been built into Chef via some other avenue, I’ll fork the current knife-cleanup plugin into a knife-scrub plugin which will build up a runlist for all roles, and keep the versions in use in any environment. Or if Marius has time then we can work on this issue together.</p>

<p>I have a short Part Three forthcoming with some other musings around depsolver and cookbook cleanup. Stay tuned.</p>

<p>Notes:</p>

<p>Marius Ducea’s blog post on knife cleanup
Useful, to me, Chef api reference
One of the posts lashing out at Chef roles
Jira ticket Role Cookbooks are a Chef AntiPattern</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Peter Burkholder</span></span>

      




<time class='entry-date' datetime='2014-07-29T12:50:11-04:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>29</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>12:50 pm</span></time>
      


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://pburkholder.github.io/blog/2014/07/29/clearing-the-counter-pt-ii-knife-cleanup-tweaks/" data-via="pburkholder" data-counturl="http://pburkholder.github.io/blog/2014/07/29/clearing-the-counter-pt-ii-knife-cleanup-tweaks/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2014/07/28/clearing-the-counter-cookbook-clutter-and-knife/" title="Previous Post: Clearing the Counter: cookbook clutter and knife cleanup">&laquo; Clearing the Counter: cookbook clutter and knife cleanup</a>
      
      
        <a class="basic-alignment right" href="/blog/2014/08/29/what-happened-to-cloud-particle-did-you-present/" title="Next Post: What happened to Cloud Particle? Did you present at DevOpsDays? Is it open source? I'm really interested, as I'm on the path of using CloudFormation, but looking for something better.">What happened to Cloud Particle? Did you present at DevOpsDays? Is it open source? I&#8217;m really interested, as I&#8217;m on the path of using CloudFormation, but looking for something better. &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>About Me</h1>
  <p>Peter Burkholder <a href="https://twitter/pburkholder">@pburkholder</a> lives outside of DC in the Maryland suburbs with two
  cats, one dog, two sons and one spouse. He&#8217;s a geophysicist turned web
  engineer turned devop. Opinions are mine.
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2016/05/09/reviving-ssl-mitm-paper/">Reviving My SSL Man-in-the-Middle Paper</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/04/27/a-thank-you-from-my-sons-school/">A “thank-you” From My Sons’ School</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/03/04/chef-custom-resources-heres-an-easy-example/">Chef Custom Resources: Here&#8217;s an Easy Example</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/02/03/lambda-to-defer-chef-code-evaluation/">Lambda to Defer Chef Code Evaluation</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/01/29/6-ways-to-resolve-chef-cookbook-version-conflicts/">6 Ways to Resolve Chef Cookbook Version Conflicts</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/pburkholder">@pburkholder</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'pburkholder',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section class="twitterOct">
  <h1 style="margin-bottom: 0.4em"> Tweets </h1>
  <a class="twitter-timeline"
	 data-dnt="true" href="https://twitter.com/pburkholder" 
     data-widget-id="729860309943521282">
     
     Tweets by @pburkholder
  </a>
  <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
</section>


  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - Peter Burkholder -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'blogpburkholdercom';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
