
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Fixing #sensuapp OpenSSL Peer Cert Validation Issues - A Blog</title>
  <meta name="author" content="Peter Burkholder">

  
  <meta name="description" content="Today I used Chef to configure a test sensu-server, but my Hipchat notifications were failing with this snippet in the logs: /opt/sensu/embedded/lib/ &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://pburkholder.github.io/blog/2014/01/23/fixing-sensuapp-openssl-peer-cert-validation/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="A Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">A Blog</a></h1>
  
    <h2>An occasional data tap into Peter Burkholder&#8217;s brain</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="pburkholder.github.io">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Fixing #sensuapp OpenSSL Peer Cert Validation Issues</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-01-23T21:41:00-05:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>23</span><span class='date-suffix'>rd</span>, <span class='date-year'>2014</span></span> <span class='time'>9:41 pm</span></time>
        
           | <a href="#disqus_thread"
             data-disqus-identifier="http://pburkholder.github.io">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>Today I used Chef to configure a test sensu-server, but my Hipchat notifications were failing with this snippet in the logs:</p>

<p>/opt/sensu/embedded/lib/ruby/2.0.0/net/http.rb:917:in `connect&#8217;&lsquo;: SSL_connect returned=1 errno=0 state=SSLv3 read server certificate B: certificate verify failed (OpenSSL::SSL::SSLError)\n&#8221;</p>

<p>I soon determined that the httparty gem was at 0.11.0 on the prod sensu servers, and at 0.12.0 on the new one. Further, that httparty had (wisely) been changed to verify peer certs. No problem, but where to put the CA (Certificate Authority) bundle?</p>

<p>Tracking this down took more of the afternoon than ideal, but eventually I determined that the default SSL cert path can be determined with:</p>

<h1>irb</h1>

<p>irb(main):001:0> require &lsquo;&#8217;openssl&rsquo;&lsquo;
=> true
irb(main):002:0> File.dirname OpenSSL::Config::DEFAULT_CONFIG_FILE
=> &ldquo;/opt/sensu/embedded/ssl&rdquo;</p>

<p>To get the CA certs into embedded ruby we can update the default sensu install with a bit of Chefery</p>

<p>cookbook_file &lsquo;&rsquo;/opt/sensu/embedded/ssl/cert.pem&#8217;&lsquo; do
  source &ldquo;cert.pem&rdquo;
  mode 0755
end</p>

<p>Where cert.pem contents are pulled from ‘<a href="http://curl.haxx.se/ca/cacert.pem%E2%80%99">http://curl.haxx.se/ca/cacert.pem%E2%80%99</a> so we have a complete list of acceptable Certificate Authorites.</p>

<p>Ideally, would submit a PR to <a href="https://github.com/sensu/sensu-build/pulls,">https://github.com/sensu/sensu-build/pulls,</a> but for now I’ll have to content myself with an issue report.</p>

<p>References:</p>

<p><a href="http://www.rdoc.info/stdlib/openssl/OpenSSL/X509/Store:set_default_paths">http://www.rdoc.info/stdlib/openssl/OpenSSL/X509/Store:set_default_paths</a>
<a href="http://www.rubyinside.com/nethttp-cheat-sheet-2940.html">http://www.rubyinside.com/nethttp-cheat-sheet-2940.html</a>
<a href="https://github.com/emboss/ruby-openssl/blob/282912788da2247d10281988a2c35818ee14912f/ext/openssl/lib/openssl/ssl-internal.rb">https://github.com/emboss/ruby-openssl/blob/282912788da2247d10281988a2c35818ee14912f/ext/openssl/lib/openssl/ssl-internal.rb</a>
Update:
- <a href="https://github.com/sensu/sensu-build/pull/79">https://github.com/sensu/sensu-build/pull/79</a> has a PR to sensu Omnibus to fix this.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Peter Burkholder</span></span>

      




<time class='entry-date' datetime='2014-01-23T21:41:00-05:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>23</span><span class='date-suffix'>rd</span>, <span class='date-year'>2014</span></span> <span class='time'>9:41 pm</span></time>
      


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://pburkholder.github.io/blog/2014/01/23/fixing-sensuapp-openssl-peer-cert-validation/" data-via="pburkholder" data-counturl="http://pburkholder.github.io/blog/2014/01/23/fixing-sensuapp-openssl-peer-cert-validation/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2014/01/09/jmx-collectd-graphite/" title="Previous Post: JMX - collectd - graphite">&laquo; JMX - collectd - graphite</a>
      
      
        <a class="basic-alignment right" href="/blog/2014/02/05/pretty-excited-about-jumbo-dice-for-new-season-of/" title="Next Post: pretty excited about jumbo dice for new season of">pretty excited about jumbo dice for new season of &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2016/05/09/reviving-ssl-mitm-paper/">Reviving My SSL Man-in-the-Middle Paper</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/04/27/a-thank-you-from-my-sons-school/">A “thank-you” From My Sons’ School</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/03/04/chef-custom-resources-heres-an-easy-example/">Chef Custom Resources: Here&#8217;s an Easy Example</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/02/03/lambda-to-defer-chef-code-evaluation/">Lambda to Defer Chef Code Evaluation</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/01/29/6-ways-to-resolve-chef-cookbook-version-conflicts/">6 Ways to Resolve Chef Cookbook Version Conflicts</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - Peter Burkholder -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'blogpburkholdercom';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
